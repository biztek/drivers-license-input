<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">

<!--
`drivers-license-input`
An Input field that validates the driver license based on the rules in the /rules.json file

@demo demo/index.html
-->

<dom-module id="drivers-license-input">
  <template>
    <style>
      :host {
        display: block;
      }

      .container {
        @apply(--layout-flex);
        @apply(--layout-vertical);
      }

      paper-item {
        padding-left: 32px;
        padding-right: 32px;
      }

    </style>
    <div class="container">
      <paper-dropdown-menu id="state" label="[[stateLabel]]" title$="[[stateTitle]]" required="[[stateRequired]]" auto-validate="[[stateAutoValidate]]" error-message="[[stateErrorMessage]]" invalid="{{stateInvalid}}">
        <paper-listbox class="dropdown-content" selected="{{state}}" attr-for-selected="name">
          <template is="dom-repeat" items="[[_states]]">
            <paper-item name="[[item]]">[[item]]</paper-item>
          </template>
        </paper-listbox>
      </paper-dropdown-menu>

      <paper-input
        id="driversLicenseNumber"
        label="[[driversLicenseLabel]]"
        disabled$="[[disabled]]"
        value="{{value}}"
        pattern="[[_pattern]]"
        autocomplete$="[[autocomplete]]"
        required="[[required]]"
        auto-validate="[[autoValidate]]"
        title$="[[driversLicenseTitle]]"
        error-message="[[errorMessage]]"
        invalid="{{invalid}}"></paper-input>
    </div>

    <iron-ajax id="ajax"
    url="[[_url]]"
    handle-as="json"
    last-response="{{_rules}}"></iron-ajax>
  </template>

  <script>
    Polymer({

      is: 'drivers-license-input',

      properties: {
        _rulesFile: {
          type: String,
          value: 'rules.json',
        },
        _url: {
          type: Boolean,
          computed: '_computeUrl(_rulesFile)',
        },

        driversLicenseLabel: {
          type: String,
          value: 'Drivers License Number'
        },
        stateLabel: {
          type: String,
          value: 'Driver\'s License State'
        },
        driversLicenseTitle: {
          type: String,
          value: 'State issued driverâ€™s license number'
        },
        stateTitle: {
          type: String,
          value: 'State abbreviation'
        },
        value: {
          type: String,
          notify: true
        },
        errorMessage: {
          type: String,
          value: 'Drivers License Number is invalid'
        },
        stateErrorMessage: {
          type: String,
          value: 'Please Select a State.'
        },
        state: {
          type: String,
          observer: '_stateChanged'
        },
        _pattern: {
          type: String,
          value: '^[0-9]{1,7}$'
        },
        _rules: {
          type: Object,
          observer: '_rulesChanged'
        },

        _states: {
          type: Array
        },

        required: {
          type: Boolean,
          value: false
        },

        autoValidate: {
          type: Boolean,
          value: false
        },

        disabled: {
          type: Boolean,
          value: false
        },

        invalid: {
          type: Boolean,
          value: false,
          notify: true
        },

        autocomplete: {
          type: Boolean,
          value: false
        },

        stateInvalid: {
          type: Boolean,
          value: false,
          notify: true
        },

        stateRequired: {
          type: Boolean,
          value: false
        },

        stateAutoValidate: {
          type: Boolean,
          value: false
        }
      },

      validate: function() {
        this.$.driversLicenseNumber.validate();
        this.$.state.validate();
        return;
      },

      _stateChanged: function(state) {
        this.$.driversLicenseNumber.disabled = false;
        this._pattern = this._rules[state].rule;
        this.errorMessage = `Drivers License should have at least ${this._rules[state].description.join(' or ')}`;
      },

      _rulesChanged: function(rules) {
        this._states = Object.keys(rules);
      },

      attached: function() {
        this.async(function() {
          this.$.ajax.generateRequest();
        }, 1);
      },

      _computeUrl: function(rulesFile) {
        return this.resolveUrl(rulesFile);
      },
    });
  </script>
</dom-module>
